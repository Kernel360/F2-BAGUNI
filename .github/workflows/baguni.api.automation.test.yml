name: Baguni Automation Api-Test CI/CD

on:
  schedule:
    # ë§¤ 3ì‹œê°„ë§ˆë‹¤ (UTC ê¸°ì¤€, 0ë¶„ì— ì‹¤í–‰)
    - cron: '0 */1 * * *'
  workflow_dispatch: # ìˆ˜ë™ìœ¼ë¡œ workflow ì‹¤í–‰ ì‹œ í•„ìš”

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      api-endpoint: https://api.staging.minlife.me

    steps:
      # ì €ì¥ì†Œ Checkout
      - name: Checkout source code
        uses: actions/checkout@v4

      # ì„œë²„ê°€ ì™„ì „íˆ ê¸°ë™ë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” ë‹¨ê³„ (í•­ìƒ ì„œë²„ê°€ ë– ìˆì–´ì•¼ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
      - name: Wait for API Server to be Ready
        run: |
          echo "ğŸ” Checking API server status..."
          attempt=0
          max_attempts=10

          while true; do
            http_status=$(curl -o /dev/null -s -w "%{http_code}" ${{ env.api-endpoint }})

            if [ "$http_status" -ne 502 ]; then
              echo "âœ… API Server responded Continuing..."
              break
            fi

            attempt=$((attempt+1))
            if [ $attempt -ge $max_attempts ]; then
              echo "âŒ API Server is still returning 502 after $max_attempts attempts. Exiting..."
              exit 1
            fi

            echo "â³ API Server still returning 502 (Bad Gateway), retrying in 5 seconds... (Attempt: $attempt)"
            sleep 5
          done

      # Node ì„¤ì¹˜
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Newman, InfluxDB reporter ì„¤ì¹˜
      - name: Install newman and InfluxDB reporter
        run: |
          npm install -g newman
          npm install -g git+https://github.com/sangwonsheep/newman-reporter-influxdb.git

      # Newman API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ InfluxDBì— ì ì¬
      - name: Run Postman collection
        run: |
          newman run ${{ secrets.POSTMAN_COLLECTION_URL }} \
            -r influxdb \
            --reporter-influxdb-org ${{ secrets.INFLUXDB_ORG }} \
            --reporter-influxdb-name ${{ secrets.INFLUXDB_BUCKET }} \
            --reporter-influxdb-username ${{ secrets.INFLUXDB_USERNAME }} \
            --reporter-influxdb-password ${{ secrets.INFLUXDB_PASSWORD }} \
            --reporter-influxdb-token ${{ secrets.INFLUXDB_TOKEN }} \
            --reporter-influxdb-version 2 \
            --reporter-influxdb-measurement newman_metrics \
            --reporter-influxdb-server influxdb.minlife.me \
            --reporter-influxdb-mode https \
            --reporter-influxdb-port 443
